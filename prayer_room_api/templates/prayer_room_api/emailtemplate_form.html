{% extends "base.html" %}

{% block title %}Edit: {{ object.get_template_type_display }} - Prayer Room{% endblock %}

{% block extra_styles %}
.editor-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
}

@media (max-width: 900px) {
    .editor-container {
        grid-template-columns: 1fr;
    }
}

.editor-panel {
    background: #fff;
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    padding: 20px;
}

.preview-panel {
    position: sticky;
    top: 20px;
}

.preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid #e5e5e5;
}

.preview-title {
    font-weight: 600;
    font-size: 1rem;
}

.preview-subtitle {
    font-size: 0.8rem;
    color: #888;
}

#preview-panel {
    min-height: 300px;
    padding: 16px;
    background: #f9fafb;
    border-radius: 6px;
}

.preview-subject {
    padding: 8px 0;
    font-size: 0.95rem;
}

.preview-body {
    padding: 12px 0;
    line-height: 1.6;
}

.preview-body h1 {
    font-size: 1.5rem;
    margin-bottom: 12px;
}

.preview-body h2 {
    font-size: 1.25rem;
    margin: 16px 0 8px;
}

.preview-body h3 {
    font-size: 1.1rem;
    margin: 12px 0 6px;
}

.preview-body p {
    margin-bottom: 12px;
}

.preview-body blockquote {
    border-left: 3px solid #ddd;
    padding-left: 16px;
    margin: 12px 0;
    color: #666;
}

.preview-body hr {
    border: none;
    border-top: 1px solid #e5e5e5;
    margin: 16px 0;
}

.variables-card {
    margin-top: 20px;
    background: #f9fafb;
    border: 1px solid #e5e5e5;
    border-radius: 6px;
}

.variables-header {
    padding: 12px 16px;
    font-weight: 600;
    font-size: 0.875rem;
    border-bottom: 1px solid #e5e5e5;
    background: #fff;
    border-radius: 6px 6px 0 0;
}

.variables-body {
    padding: 12px 16px;
    max-height: 250px;
    overflow-y: auto;
}

.variable-item {
    display: flex;
    gap: 12px;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
    font-size: 0.85rem;
}

.variable-item:last-child {
    border-bottom: none;
}

.variable-name {
    font-family: monospace;
    background: #e5e7eb;
    padding: 2px 6px;
    border-radius: 4px;
    white-space: nowrap;
    font-size: 0.8rem;
}

.variable-desc {
    color: #666;
}

.form-actions {
    margin-top: 20px;
    display: flex;
    gap: 12px;
}

.htmx-request .htmx-indicator {
    display: inline;
}

.htmx-indicator {
    display: none;
    color: #888;
    font-size: 0.85rem;
}

.template-type-display {
    padding: 10px 12px;
    background: #f5f5f5;
    border: 1px solid #ddd;
    border-radius: 6px;
    color: #666;
}
{% endblock %}

{% block content %}
<h1>Edit: {{ object.get_template_type_display }}</h1>
<p class="subtitle">{{ context_info.description }}</p>

<div class="editor-container">
    <!-- Left: Editor -->
    <div class="editor-panel">
        <form method="post">
            {% csrf_token %}

            <div class="form-group">
                <label>Template Type</label>
                <div class="template-type-display">
                    {{ object.get_template_type_display }}
                </div>
            </div>

            <div class="form-group">
                <label for="id_subject">Subject</label>
                <input type="text"
                       name="subject"
                       id="id_subject"
                       class="form-input"
                       value="{{ object.subject }}"
                       hx-post="{% url 'emailtemplate-preview' object.pk %}"
                       hx-trigger="keyup changed delay:300ms"
                       hx-target="#preview-panel"
                       hx-include="[name='body_markdown']">
            </div>

            <div class="form-group">
                <label for="id_body_markdown">Body (Markdown)</label>
                <textarea name="body_markdown"
                          id="id_body_markdown"
                          class="form-input"
                          rows="18"
                          hx-post="{% url 'emailtemplate-preview' object.pk %}"
                          hx-trigger="load keyup changed delay:300ms"
                          hx-target="#preview-panel"
                          hx-include="[name='subject']">{{ object.body_markdown }}</textarea>
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox"
                           name="is_active"
                           class="form-checkbox"
                           {% if object.is_active %}checked{% endif %}>
                    Active
                </label>
            </div>

            <!-- Context Variables Reference -->
            <div class="variables-card">
                <div class="variables-header">Available Variables</div>
                <div class="variables-body">
                    {% for var_name, var_desc in context_info.variables.items %}
                    <div class="variable-item">
                        <span class="variable-name">{% templatetag openvariable %} {{ var_name }} {% templatetag closevariable %}</span>
                        <span class="variable-desc">{{ var_desc }}</span>
                    </div>
                    {% empty %}
                    <p style="color: #888; font-size: 0.85rem;">No variables available for this template type.</p>
                    {% endfor %}
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Save Template</button>
                <a href="{% url 'emailtemplate-list' %}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>

    <!-- Right: Live Preview -->
    <div class="editor-panel preview-panel">
        <div class="preview-header">
            <div>
                <div class="preview-title">Preview</div>
                <div class="preview-subtitle">(with example data)</div>
            </div>
            <span class="htmx-indicator">Updating...</span>
        </div>
        <div id="preview-panel">
            <div style="color: #888;">Start typing to see preview...</div>
        </div>
    </div>
</div>
{% endblock %}
